name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  code-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Get PR diff
        id: diff
        run: |
          # Get the diff between the base and head of the PR
          DIFF=$(git diff ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} -- '*.py')
          
          # Truncate if too long (OpenRouter has token limits)
          if [ ${#DIFF} -gt 40000 ]; then
            DIFF="${DIFF:0:40000}"
            DIFF="$DIFF\n\n... (truncated due to length)"
          fi
          
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Get PR details
        id: pr-details
        run: |
          echo "title<<EOF" >> $GITHUB_OUTPUT
          echo "${{ github.event.pull_request.title }}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "${{ github.event.pull_request.body }}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Call OpenRouter API
        id: openrouter
        run: |
          RESPONSE=$(curl -s https://openrouter.ai/api/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.OPENROUTER_API_KEY }}" \
            -H "HTTP-Referer: https://github.com/${{ github.repository }}" \
            -H "X-Title: ${{ github.repository }}" \
            -d '{
              "model": "minimax/minimax-m2.5",
              "messages": [
                {
                  "role": "system",
                  "content": "You are an expert code reviewer. Your task is to review pull request changes and provide constructive feedback. Focus on:\n\n1. Potential bugs and security issues\n2. Code quality and best practices (Python)\n3. Performance concerns\n4. Missing error handling\n5. Code readability and maintainability\n6. Test coverage\n\nProvide concise, specific, and actionable feedback. Be polite and professional."
                },
                {
                  "role": "user",
                  "content": "Please review the following pull request changes for repository ${{ github.repository }}:\n\nPR Title: ${{ steps.pr-details.outputs.title }}\nPR Description: ${{ steps.pr-details.outputs.body }}\n\nChanged files diff:\n${{ steps.diff.outputs.diff }}\n\nProvide a thorough code review with specific suggestions."
                }
              ],
              "max_tokens": 2000
            }')
          
          # Extract the response content
          MESSAGE=$(echo $RESPONSE | jq -r '.choices[0].message.content // empty')
          
          if [ -z "$MESSAGE" ]; then
            # Check for errors
            ERROR=$(echo $RESPONSE | jq -r '.error.message // "Unknown error"')
            echo "review<<EOF" >> $GITHUB_OUTPUT
            echo "⚠️ Code review failed: $ERROR" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "review<<EOF" >> $GITHUB_OUTPUT
            echo "$MESSAGE" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Post review comment
        if: steps.openrouter.outputs.review
        env:
          REVIEW: ${{ steps.openrouter.outputs.review }}
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body "$REVIEW"
