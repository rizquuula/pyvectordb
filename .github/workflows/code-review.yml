name: AI Code Review

on:
  pull_request:
    branches: [main]
  pull_request_review:

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Get diff
        id: diff
        run: |
          # Get the diff between the base and head of the PR
          DIFF=$(git diff ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} -- '*.py')
          
          # Truncate if too long (OpenRouter has token limits)
          if [ ${#DIFF} -gt 40000 ]; then
            DIFF="${DIFF:0:40000}"
            echo "diff_truncated=true" >> $GITHUB_OUTPUT
          else
            echo "diff_truncated=false" >> $GITHUB_OUTPUT
          fi
          
          # Escape for JSON
          DIFF="${DIFF//'%'/'%25'}"
          DIFF="${DIFF//$'\n'/'%0A'}"
          DIFF="${DIFF//$'\r'/'%0D'}"
          
          echo "diff=$DIFF" >> $GITHUB_OUTPUT

      - name: Call OpenRouter API
        id: openrouter
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          RESPONSE=$(curl -s https://openrouter.ai/api/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: $OPENROUTER_API_KEY" \
            -H "HTTP-Referer: https://github.com/rizquuula/pyvectordb" \
            -H "X-Title: rizquuula/pyvectordb" \
            -d '{
              "model": "minimax/minimax-m2.5",
              "messages": [
                {
                  "role": "system",
                  "content": "You are an expert code reviewer. Your task is to review pull request changes and provide constructive feedback. Focus on:\n\n1. Potential bugs and security issues\n2. Code quality and best practices (Python)\n3. Performance concerns\n4. Missing error handling\n5. Code readability and maintainability\n6. Test coverage\n\nProvide concise, specific, and actionable feedback. Be polite and professional."
                },
                {
                  "role": "user",
                  "content": "Please review the following pull request changes for repository rizquuula/pyvectordb:\n\nPR Title: ${{ github.event.pull_request.title }}\nPR Description: ${{ github.event.pull_request.body }}\n\nChanged files diff:\n${{ steps.diff.outputs.diff }}"
                }
              ],
              "max_tokens": 2000
            }')
          
          # Extract the response content
          MESSAGE=$(echo $RESPONSE | jq -r '.choices[0].message.content // empty')
          
          if [ -z "$MESSAGE" ]; then
            # Check for errors
            ERROR=$(echo $RESPONSE | jq -r '.error.message // "Unknown error"')
            echo "review<<EOF" >> $GITHUB_OUTPUT
            echo "⚠️ Code review failed: $ERROR" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "review<<EOF" >> $GITHUB_OUTPUT
            echo "$MESSAGE" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi
        shell: /usr/bin/bash

      - name: Post review comment
        uses: actions/github-script@v7
        if: steps.openrouter.outputs.review
        with:
          github-token: ${{ github.token }}
          script: |
            const review = `${{ steps.openrouter.outputs.review }}`;
            
            // Check if it's an error message
            if (review.includes('⚠️ Code review failed')) {
              console.log('Review failed, posting error message');
            }
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: review
            });